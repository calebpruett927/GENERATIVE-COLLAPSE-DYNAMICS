// UMCP Development Container — v2.1.2
// Python 3.12 on Debian Bookworm, matching CI (validate.yml).
// Includes: ruff, mypy, pytest, LaTeX (RevTeX4-2), and full project deps.
{
	"name": "UMCP Development",
	"build": {
		"dockerfile": "Dockerfile",
		"context": ".."
	},

	// Dev container features — git, GitHub CLI, common utilities
	"features": {
		"ghcr.io/devcontainers/features/github-cli:1": {},
		"ghcr.io/devcontainers/features/common-utils:2": {
			"installZsh": true,
			"configureZshAsDefaultShell": true,
			"installOhMyZsh": true,
			"upgradePackages": true
		}
	},

	// Bootstrap the project after container creation
	"postCreateCommand": "bash .devcontainer/post-create.sh",

	// Ports: FastAPI (8000), Streamlit dashboard (8501)
	"forwardPorts": [8000, 8501],
	"portsAttributes": {
		"8000": { "label": "UMCP API", "onAutoForward": "notify" },
		"8501": { "label": "UMCP Dashboard", "onAutoForward": "notify" }
	},

	// Container environment variables
	"containerEnv": {
		"PYTHONDONTWRITEBYTECODE": "1",
		"PYTHONUNBUFFERED": "1",
		"PIP_DISABLE_PIP_VERSION_CHECK": "1",
		"PIP_NO_CACHE_DIR": "1",
		"UMCP_DEV": "1"
	},

	"customizations": {
		"vscode": {
			// Essential extensions only
			"extensions": [
				"ms-python.python",
				"ms-python.vscode-pylance",
				"ms-python.debugpy",
				"charliermarsh.ruff",
				"ms-python.mypy-type-checker",
				"redhat.vscode-yaml",
				"james-yu.latex-workshop",
				"github.copilot"
			],

			"settings": {
				// ── Python ──
				"python.defaultInterpreterPath": "/usr/local/bin/python",
				"python.terminal.activateEnvironment": false,
				"python.analysis.typeCheckingMode": "basic",
				"python.analysis.autoImportCompletions": true,

				// ── Ruff (format + lint on save, matching CI) ──
				"[python]": {
					"editor.defaultFormatter": "charliermarsh.ruff",
					"editor.formatOnSave": true,
					"editor.codeActionsOnSave": {
						"source.fixAll.ruff": "explicit",
						"source.organizeImports.ruff": "explicit"
					}
				},
				"ruff.lineLength": 120,
				"ruff.configuration": "pyproject.toml",

				// ── mypy ──
				"mypy-type-checker.args": ["--config-file=pyproject.toml"],
				"mypy-type-checker.reportingScope": "file",

				// ── pytest ──
				"python.testing.pytestEnabled": true,
				"python.testing.unittestEnabled": false,
				"python.testing.pytestArgs": ["-q", "--tb=short"],

				// ── YAML (contracts, closures, canon) ──
				"yaml.schemas": {
					"schemas/contract.schema.json": "contracts/*.yaml",
					"schemas/manifest.schema.json": "casepacks/*/manifest.json",
					"schemas/canon.schema.json": "canon/*.yaml",
					"schemas/closure.schema.json": "closures/**/*.yaml"
				},
				"yaml.format.enable": true,

				// ── LaTeX (paper/) — compile in-place, matching tracked PDFs ──
				"latex-workshop.latex.recipe.default": "latexmk (pdflatex)",
				"latex-workshop.latex.rootFile.useSubFile": true,
				"latex-workshop.latex.autoClean.run": "onBuilt",
				"latex-workshop.chktex.enabled": true,
				"latex-workshop.chktex.args.active": [
					"-wall", "-n1", "-n3", "-n8", "-n24", "-n36", "-n44"
				],

				// ── Editor ──
				"editor.rulers": [120],
				"editor.tabSize": 4,
				"editor.insertSpaces": true,
				"editor.trimAutoWhitespace": true,
				"editor.bracketPairColorization.enabled": true,
				"editor.guides.bracketPairs": "active",
				"files.trimTrailingWhitespace": true,
				"files.insertFinalNewline": true,
				"files.trimFinalNewlines": true,

				// ── File associations ──
				"files.associations": {
					"*.yaml": "yaml",
					"*.yml": "yaml",
					"*.schema.json": "json"
				},

				// ── Search & file exclusions ──
				"search.exclude": {
					"**/__pycache__": true,
					"**/.pytest_cache": true,
					"**/*.egg-info": true,
					"**/node_modules": true,
					".ruff_cache": true,
					".mypy_cache": true,
					"integrity/": true
				},
				"files.exclude": {
					"**/__pycache__": true,
					"**/.pytest_cache": true,
					"**/*.egg-info": true
				},
				"files.watcherExclude": {
					"**/__pycache__/**": true,
					"**/.pytest_cache/**": true,
					"**/*.egg-info/**": true,
					"**/.git/objects/**": true,
					"**/.ruff_cache/**": true,
					"**/.mypy_cache/**": true
				},

				// ── Terminal ──
				"terminal.integrated.defaultProfile.linux": "zsh",
				"terminal.integrated.scrollback": 10000
			}
		}
	},

	// Run as non-root for security
	"remoteUser": "vscode"
}
