# KIN.REF.PHASE Oscillator CasePack - Closure Registry
# Specifies closures used for phase-anchor selection

schema: "schemas/closures_registry.schema.json"

registry:
  id: "UMCP.CLOSURES.KIN_REF_PHASE.v1"
  description: "Closure registry for KIN.REF.PHASE phase-anchor selection casepack"
  contract: "KIN.INTSTACK.v1"

  # Base closures (inherited from UMCP)
  base_closures:
    gamma:
      path: "closures/gamma.default.v1.yaml"
    return_domain:
      path: "closures/return_domain.window64.v1.yaml"
    norms:
      path: "closures/norms.l2_eta1e-3.v1.yaml"

  # KIN.REF.PHASE specific closure
  phase_anchor_closures:
    kin_ref_phase:
      id: "KIN.REF.PHASE.v1"
      path: "casepacks/kin_ref_phase_oscillator/closures/kin_ref_phase.py"
      function: "select_phase_anchor"
      description: "Deterministic phase-anchor selection for oscillatory motion"

      # Inputs
      inputs:
        - name: "x_series"
          type: "array[float]"
          description: "Time series of normalized positions"
        - name: "v_series"
          type: "array[float]"
          description: "Time series of normalized velocities"
        - name: "t"
          type: "int"
          description: "Current time index"

      # Outputs
      outputs:
        - name: "anchor_u"
          type: "int | null"
          description: "Selected anchor index, or null if undefined"
        - name: "delta_phi"
          type: "float | null"
          description: "Phase distance to anchor, or null if undefined"
        - name: "undefined_reason"
          type: "string"
          description: "NONE | EMPTY_ELIGIBLE | PHASE_MISMATCH"
        - name: "phi"
          type: "float"
          description: "Phase angle at current index"
        - name: "eligible_count"
          type: "int"
          description: "Number of eligible anchors"

      # Frozen parameters
      frozen_params:
        delta_phi_max:
          value: 0.5235987756
          description: "Maximum phase mismatch (π/6 = 30°)"
        window:
          value: 20
          description: "Return-domain window size (samples)"
        debounce:
          value: 3
          description: "Debounce lag (samples)"

      # Tie-breaker specification
      tie_breakers:
        order:
          - "minimize_delta_phi"
          - "choose_most_recent_u"
          - "minimize_psi_distance"
        description: "Tie-breaker order for deterministic selection"

  # Validation parameters
  validation:
    determinism:
      required: true
      description: "Two runs with same input must produce identical output"
    coverage:
      edge_cases:
        - "empty_eligible"
        - "phase_mismatch"
        - "tie_breaker"
