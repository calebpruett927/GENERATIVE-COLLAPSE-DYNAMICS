name: validate

on:
  push:
  pull_request:

permissions:
  contents: read

jobs:
  lint:
    name: Code quality (Ruff + mypy)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run Ruff format check
        run: |
          ruff format --check .

      - name: Run Ruff lint
        run: |
          ruff check .

      - name: Run mypy
        run: |
          mypy src/umcp --config-file=pyproject.toml
        continue-on-error: true  # Allow to fail initially while adding type coverage

  test:
    name: Run pytest suite
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests
        run: |
          python -m pytest -v --tb=short --cov=umcp --cov-report=term-missing --cov-fail-under=80

  umcp-validate:
    name: UMCP validate (baseline + strict)
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Validate (baseline) + write report
        run: |
          umcp validate . --out validator.result.baseline.json

      - name: Check baseline validation status
        run: |
          STATUS=$(python -c "import json; print(json.load(open('validator.result.baseline.json'))['run_status'])")
          echo "Baseline validation status: $STATUS"
          if [ "$STATUS" != "CONFORMANT" ]; then
            echo "❌ Baseline validation failed with status: $STATUS"
            cat validator.result.baseline.json
            exit 1
          fi
          echo "✅ Baseline validation CONFORMANT"

      - name: Validate E2E case (strict mode)
        run: |
          umcp validate --strict casepacks/UMCP-REF-E2E-0001 --out validator.result.strict.json

      - name: Check strict validation status
        run: |
          STATUS=$(python -c "import json; result = json.load(open('validator.result.strict.json')); targets = [t for t in result.get('targets', []) if 'UMCP-REF-E2E-0001' in t.get('target_path', '')]; print(targets[0]['run_status'] if targets else 'UNKNOWN')")
          echo "Strict validation status: $STATUS"
          if [ "$STATUS" != "CONFORMANT" ]; then
            echo "❌ Strict validation failed for E2E case with status: $STATUS"
            cat validator.result.strict.json
            exit 1
          fi
          echo "✅ Strict validation CONFORMANT for E2E case"

      - name: Upload validator reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: validator-results
          path: |
            validator.result.baseline.json
            validator.result.strict.json
