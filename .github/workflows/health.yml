name: health-check

# Scheduled weekly drift detection ‚Äî catches problems that accumulate
# between pushes (freeze drift, version inconsistency, broken refs).
# Also runs on manual trigger for ad-hoc checks.

on:
  schedule:
    - cron: '0 6 * * 1'  # Every Monday at 06:00 UTC
  workflow_dispatch:       # Manual trigger from Actions tab

permissions:
  contents: read
  issues: write            # Needed to create drift-alert issues

jobs:
  health:
    name: Repository health check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for tag-based checks

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run health check
        id: health
        run: |
          python scripts/repo_health_check.py --json > health_report.json 2>&1 || true
          python scripts/repo_health_check.py
          echo "exit_code=$?" >> "$GITHUB_OUTPUT"

      - name: Upload health report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: health-report
          path: health_report.json
          retention-days: 30

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let body = '## Repository Health Check Failed\n\n';
            body += 'The scheduled health check detected problems that need attention.\n\n';

            try {
              const report = JSON.parse(fs.readFileSync('health_report.json', 'utf8'));
              body += `**Status**: ${report.status}\n`;
              body += `**Errors**: ${report.errors}\n`;
              body += `**Warnings**: ${report.warnings}\n\n`;

              if (report.findings && report.findings.length > 0) {
                body += '### Findings\n\n';
                for (const f of report.findings) {
                  const icon = f.severity === 'ERROR' ? '‚ùå' : f.severity === 'WARN' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
                  body += `- ${icon} **[${f.severity}]** ${f.message}\n`;
                  if (f.detail) body += `  - ${f.detail}\n`;
                }
              }
            } catch (e) {
              body += '_Could not parse health report JSON._\n';
            }

            body += '\n---\n_Auto-generated by the weekly health check workflow._';

            // Check for existing open issue to avoid duplicates
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'health-check',
              state: 'open',
            });

            if (issues.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'üè• Repository Health Check Failed',
                body: body,
                labels: ['health-check', 'automated'],
              });
            } else {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body: body,
              });
            }
